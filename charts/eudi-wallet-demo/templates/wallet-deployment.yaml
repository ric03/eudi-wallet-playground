apiVersion: apps/v1
kind: Deployment
metadata:
  name: wallet-demo-wallet
  labels:
    app: wallet-demo
    app.kubernetes.io/component: wallet
spec:
  replicas: 1
  selector:
    matchLabels:
      app: wallet-demo
      app.kubernetes.io/component: wallet
  template:
    metadata:
      labels:
        app: wallet-demo
        app.kubernetes.io/component: wallet
    spec:
      serviceAccountName: default
      initContainers:
        - name: wallet-config-init
          image: busybox:1.36
          command: [ "/bin/sh", "-c" ]
          args:
            - |
              set -eu
              mkdir -p /work/config
              for f in /seed/secret/*; do
                [ -e "$f" ] || continue
                target="/work/config/$(basename "$f")"
                if [ ! -f "$target" ]; then
                  cp "$f" "$target"
                fi
              done
              for f in /seed/config/*; do
                [ -e "$f" ] || continue
                target="/work/config/$(basename "$f")"
                if [ ! -f "$target" ]; then
                  cp "$f" "$target"
                fi
              done
          volumeMounts:
            - name: wallet-data
              mountPath: /work
            - name: wallet-keys-seed
              mountPath: /seed/secret
            - name: wallet-config-seed
              mountPath: /seed/config
      containers:
        - name: wallet
          image: "{{ required "wallet.image.repository is required" .Values.wallet.image.repository }}:{{ required "wallet.image.tag is required" .Values.wallet.image.tag }}"
          imagePullPolicy: IfNotPresent
          env:
            - name: SERVER_SERVLET_CONTEXT_PATH
              value: /wallet
            - name: SERVER_FORWARD_HEADERS_STRATEGY
              value: "framework"
            - name: WALLET_PUBLIC_BASE_URL
              value: {{ required "wallet.publicBaseUrl is required" .Values.wallet.publicBaseUrl }}
            - name: KEYCLOAK_BASE_URL
              value: {{ required "wallet.keycloakBaseUrl is required" .Values.wallet.keycloakBaseUrl }}
            - name: KEYCLOAK_REALM
              value: {{ .Values.wallet.keycloakRealm }}
            - name: OIDC_CLIENT_ID
              value: {{ .Values.wallet.clientId }}
            - name: OIDC_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: wallet-demo-wallet
                  key: oidc-client-secret
            - name: WALLET_DID
              value: {{ .Values.wallet.env.walletDid }}
            - name: WALLET_KEY_FILE
              value: "/data/config/wallet-keys.json"
            - name: VERIFIER_KEYS_FILE
              value: "/data/config/verifier-keys.json"
            - name: MOCK_ISSUER_KEY_FILE
              value: "/data/config/mock-issuer-keys.json"
            - name: MOCK_ISSUER_CONFIGURATION_FILE
              value: "/data/config/mock-issuer-configurations.json"
            - name: MOCK_ISSUER_ISSUER_ID
              value: {{ default (printf "%s/mock-issuer" (required "wallet.publicBaseUrl is required" .Values.wallet.publicBaseUrl)) .Values.wallet.mockIssuer.issuerId }}
            - name: CREDENTIAL_STORAGE_DIR
              value: {{ .Values.wallet.env.credentialStorageDir }}
            - name: VERIFIER_CLIENT_ID
              value: {{ .Values.wallet.env.verifierClientId }}
            - name: VERIFIER_CLIENT_ID_SCHEME
              value: {{ .Values.wallet.env.verifierClientIdScheme }}
            - name: VERIFIER_WALLET_AUTH_ENDPOINT
              value: {{ .Values.wallet.env.verifierWalletAuthEndpoint }}
            - name: DCQL_QUERY_FILE
              value: {{ .Values.wallet.env.dcqlQueryFile }}
            - name: DEFAULT_DCQL_QUERY
              value: {{ .Values.wallet.env.defaultDcqlQuery }}
            - name: MAX_HTTP_REQUEST_HEADER_SIZE
              value: {{ .Values.wallet.env.maxHttpRequestHeaderSize }}
            - name: MAX_HTTP_RESPONSE_HEADER_SIZE
              value: {{ .Values.wallet.env.maxHttpResponseHeaderSize }}
            - name: VERIFIER_MAX_REQUEST_OBJECT_INLINE_BYTES
              value: {{ .Values.wallet.env.verifierMaxRequestObjectInlineBytes | quote }}
          ports:
            - containerPort: 3000
              name: http
          readinessProbe:
            httpGet:
              path: /wallet
              port: http
            initialDelaySeconds: 15
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /wallet
              port: http
            initialDelaySeconds: 30
            periodSeconds: 20
          volumeMounts:
            - name: wallet-data
              mountPath: /data
          resources:
            requests:
              cpu: 200m
              memory: 512Mi
            limits:
              cpu: 1
              memory: 1Gi
      volumes:
        - name: wallet-config-seed
          configMap:
            name: wallet-demo-wallet-config
        - name: wallet-keys-seed
          secret:
            secretName: wallet-demo-wallet-keys
        - name: wallet-data
          emptyDir: {}
